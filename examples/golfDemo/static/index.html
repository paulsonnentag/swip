<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Swip Golf</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }

      canvas {
        cursor: pointer;
      }

    </style>
  </head>

  <body>

    <canvas id="canvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/swip/swip.js"></script>
    <script>
      var socket = io.connect();

      var canvas = document.getElementById('canvas');
      var ctx = canvas.getContext("2d");

      canvas.setAttribute('width', window.innerWidth);
      canvas.setAttribute('height', window.innerHeight);

      ctx.fillStyle = '#333333';
      ctx.fillRect(0,0, canvas.width, canvas.height);

      function drawOpenings (ctx, client) {
        var openings = client.openings;
        var transformX = client.transform.x;
        var transformY = client.transform.y;
        var width = client.size.width;
        var height = client.size.height;

        ctx.lineWidth = 5;
        ctx.shadowBlur=5;

        openings.left.forEach(function (wall) {
          ctx.strokeStyle = "#ff9e00";
          ctx.shadowColor="#ff9e00";

          ctx.beginPath();
          ctx.moveTo(transformX, wall.start + transformY);
          ctx.lineTo(transformX, wall.end + transformY);
          ctx.stroke();
        });

        openings.top.forEach(function (wall) {
          ctx.strokeStyle = "#0084FF";
          ctx.shadowColor="#0084FF";

          ctx.beginPath();
          ctx.moveTo(wall.start + transformX, transformY);
          ctx.lineTo(wall.end + transformX, transformY);
          ctx.stroke();
        });

        openings.right.forEach(function (wall) {
          ctx.strokeStyle = "#0084FF";
          ctx.shadowColor="#0084FF";

          ctx.beginPath();
          ctx.moveTo(width + transformX, wall.start + transformY);
          ctx.lineTo(width + transformX, wall.end + transformY);
          ctx.stroke();
        });

        openings.bottom.forEach(function (wall) {
          ctx.strokeStyle = "#ff9e00";
          ctx.shadowColor="#ff9e00";

          ctx.beginPath();
          ctx.moveTo(wall.start + transformX, height + transformY);
          ctx.lineTo(wall.end + transformX, height + transformY);
          ctx.stroke();
        });
      }

      swip.init({ socket: socket, container: canvas }, function (client) {
        const converter = client.converter;

        var startPos = {};
        var middlePos;
        var endPos = {};

        client.onClick(function (evt) {
          var hole = { x: evt.position.x, y: evt.position.y };

          client.emit('setHole', hole);
        });

        client.onDragStart(function (evt) {
          startPos = { x: evt.position[0].x, y: evt.position[0].y };
        });

        client.onDragMove(function (evt) {
          middlePos = { x: evt.position[0].x, y: evt.position[0].y };
        });

        client.onDragEnd(function (evt) {
          endPos = { x: evt.position[0].x, y: evt.position[0].y };
          middlePos = null;

          client.emit('hitBall', { speedX: (startPos.x - endPos.x), speedY:  (startPos.y - endPos.y) });
        });

        client.onUpdate(function (evt) {

          if (evt.cluster.data.golfball) {
            ctx.fillRect(0,0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-converter.toDevicePixel(evt.client.transform.x), -converter.toDevicePixel(evt.client.transform.y));
            ctx.scale(converter.toDevicePixel(1), converter.toDevicePixel(1));

            drawOpenings(ctx, evt.client);

            if (middlePos) {
              ctx.strokeStyle = '#FFFFFF';
              ctx.lineWidth = 3;
              ctx.shadowBlur= 5;
              ctx.beginPath();
              ctx.moveTo(middlePos.x, middlePos.y);
              ctx.lineTo(startPos.x, startPos.y);
              ctx.stroke();
            }

            var golfball = evt.cluster.data.golfball;

            ctx.fillStyle = '#FFFFFF';
            ctx.shadowBlur= 0;
            ctx.beginPath();
            ctx.arc(golfball.x, golfball.y, golfball.size, 0, 2 * Math.PI);
            ctx.fill();

            var hole = evt.cluster.data.hole;

            ctx.fillStyle = '#FF6666';
            ctx.beginPath();
            ctx.arc(hole.x, hole.y, 25, 0, 2 * Math.PI);
            ctx.fill();

            if (evt.cluster.data.gameOver) {
              alert('Game Over!');
            }

            ctx.restore();
          }
        });
      });
    </script>
  </body>
</html>





